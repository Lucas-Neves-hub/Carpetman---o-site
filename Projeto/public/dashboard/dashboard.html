<!DOCTYPE html>
<html lang="pt-br">

<head>
    <link rel="shortcut icon" href="../assets/icon/favicon2.ico" type="image/x-icon">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carpetman | Dashboards</title>

    
    <link rel="stylesheet" href="./../css/dashboards.css">
    <link rel="stylesheet" href="./../css/estilo.css" />
    <script src="../js/sessao.js"></script>
    

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link' href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
        rel="stylesheet">

    <!-- scripts do Chart.js - 2022-1 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

   
</head>

<!-- <body onload=" atualizarFeed()"> -->

<body onload="formarKPI(), formarKPI2(), formarKPI3()">

    <div class="janela">
        <div class="header-left">
            <h1>Carpetman</h1>

            <div class="hello">
                <h3>Olá, <span id="b_usuario">usuário</span>!</h3>
            </div>

            <div class="btn-nav-white">
                <a href="./cards.html">
                    <h3>Videoclipes</h3>
                </a>
            </div>

            <div class="btn-nav">

                <h3>Opiniões</h3>

            </div>

            <div class="btn-nav-white">
                <a href="./quiz.html">
                    <h3>Quiz de conhecimento</h3>
                </a>
            </div>

            <div class="btn-logout" onclick="limparSessao()">
                <h3>Sair</h3>
            </div>

        </div>

        <div class="dash">
        

            <div class="btns-dash" id="btnAquario">
                <!-- O gráfico é chamado de acordo com o id (fk_aquario) do banco  -->
            </div>
            <div id="KPIS">
                
                <div id="KPI1"></div>
                <div id="KPI2"></div>
                <div id="KPI3"></div>
               
            </div>
            <div id="graficos">
                <div id="grafico1"><h1 style="color: aliceblue;">Suas opiniões</h1>
                    <canvas id="myChartCanvas"></canvas>
                </div>
                    <div id="grafico2"><h1 style="color: aliceblue;">Opiniões de todos os usuários</h1>
                        <canvas id="myChartCanvas1"></canvas>
                    </div>
            </div>
        </div>
    </div>


</body>

</html>

<script>
var div = ''
function formarKPI(fkUsuario){
    var fkUsuario = sessionStorage.ID_USUARIO
fetch(`http://localhost:8080/KPI/${fkUsuario}`, { cache: 'no-store' }).then(res => res.json()).then(Longas => {
    console.log(`Dados recebidos: ${Longas[0]["count(opiniao)"]}`)
    

    

 KPI1.innerHTML=`<h3>Você curtiu ${Longas[0]["count(opiniao)"]}/8 das músicas de duração longa!!</h3>`
})   .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
    })
    
}

 function formarKPI3(){
    var fkUsuario = sessionStorage.ID_USUARIO
fetch(`/KPI3/${fkUsuario}`, { cache: 'no-store' }).then(res => res.json()).then(Curtas => {
    console.log(`Dados recebidos: ${Curtas[0]["count(opiniao)"]}`)
     KPI3.innerHTML=`<h3>Você curtiu ${Curtas[0]["count(opiniao)"]}/3 das músicas de duração curta!!</h3>`
})   .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
    })






 }


  function formarKPI2(){
    var fkUsuario = sessionStorage.ID_USUARIO
fetch(`/KPI2/${fkUsuario}`, { cache: 'no-store' }).then(res => res.json()).then(Medias => {
    console.log(`Dados recebidos: ${Medias[0]["count(opiniao)"]}`)
     KPI2.innerHTML=`<h3>Você curtiu ${Medias[0]["count(opiniao)"]}/10 das músicas de duração mediana!!</h3>`
})   .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
    })






 }



setInterval(formarKPI,2000)
setInterval(formarKPI2,2000)
setInterval(formarKPI3,2000)
formarKPI()
formarKPI2()
formarKPI3()
    b_usuario.innerHTML = sessionStorage.NOME_USUARIO;
    var likes = 0
    var myChart = ''

    // O gráfico é construído com três funções:
    // 1. obterDadosGrafico -> Traz dados do Banco de Dados para montar o gráfico da primeira vez
    // 2. plotarGrafico -> Monta o gráfico com os dados trazidos e exibe em tela
    // 3. atualizarGrafico -> Atualiza o gráfico, trazendo novamente dados do Banco

    // Esta função *obterDadosGrafico* busca os últimos dados inseridos em tabela de medidas.
    // para, quando carregar o gráfico da primeira vez, já trazer com vários dados.
    // A função *obterDadosGrafico* também invoca a função *plotarGrafico*

    //     Se quiser alterar a busca, ajuste as regras de negócio em src/controllers
    //     Para ajustar o "select", ajuste o comando sql em src/models






















    function grafico() {
var fkUsuario = sessionStorage.ID_USUARIO
       
        fetch(`http://localhost:8080/grafico/graficoTotalL`, { cache: 'no-store' }).then(res => res.json()).then(Curtidas => {
            fetch(`/grafico/graficoTotalD`, { cache: 'no-store' }).then(res => res.json()).then(Descurtidas => {

        fetch(`http://localhost:8080/grafico/grafico/${fkUsuario}`, { cache: 'no-store' }).then(res => res.json()).then(likes => {

        fetch(`http://localhost:8080/grafico/graficoDois/${fkUsuario}`, { cache: 'no-store' }).then(res => res.json()).then(dislikes => {
                    console.log(`Dados recebidos: ${likes}`)
                     console.log(`Dados recebidos: ${dislikes}`);

                    plotarGrafico(Curtidas, Descurtidas, likes, dislikes)})
        })})})

            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
    });
    }

   


    

    // Esta função *plotarGrafico* usa os dados capturados na função anterior para criar o gráfico
    // Configura o gráfico (cores, tipo, etc), materializa-o na página e, 
    // A função *plotarGrafico* também invoca a função *atualizarGrafico*
    function plotarGrafico(Curtidas, Descurtidas, likes, dislikes) {
var fkUsuario = sessionStorage.ID_USUARIO
        console.log('iniciando plotagem do gráfico...');

        // Criando estrutura para plotar gráfico - labels
    

        // Criando estrutura para plotar gráfico - dados
        const dados = {
            labels: ['Opiniões'],
            datasets: [{
                label: 'Músicas que você gostou',
                data:[likes[0]["count(opiniao)"]],
                barPercentage: 0.5,
                fill: false,
                backgroundColor: 'rgb(54, 162, 235)',
                borderColor: 'blue',
            
            },
        {
                label: 'Músicas que você não gostou',
                data:[dislikes[0]["count(opiniao)"]],
                barPercentage: 0.5,
                fill: false,
                backgroundColor: '#FF2C2C',
                borderColor: 'rgba(72, 149, 239, 0.7)',
            
            }]
        };

        console.log('----------------------------------------------')
        console.log('Estes dados foram recebidos pela funcao "grafico" e passados para "plotarGrafico":')
        console.log(likes)
        console.log(dislikes)

       

        console.log('----------------------------------------------')
        console.log('O gráfico será plotado com os respectivos valores:')
        console.log('Dados:')
        console.log(likes)
        console.log(dislikes)
        console.log('----------------------------------------------')

        // Criando estrutura para plotar gráfico - config
        const config = {
            type: 'bar',
            data: dados
        };
        

        // Adicionando gráfico criado em div na tela
         myChart = new Chart(
            document.getElementById(`myChartCanvas`),
            config
        );


        const data = {
            
  labels: [
    'Descurtida',
        'Curtida'
  ],
  datasets: [{
    label: 'Opiniões',
    data: [Descurtidas[0]["count(opiniao)"],Curtidas[0]["count(opiniao)"]],
    backgroundColor: [
      
      '#FF2C2C',
      'rgb(54, 162, 235)'
    ],
    hoverOffset: 4,
   
  }],
   option:{
                response: true,
            }
};

       
        
        const conf = {
            type: 'doughnut',
            data: data
        };
        

        // Adicionando gráfico criado em div na tela
         myChart1 = new Chart(
            document.getElementById(`myChartCanvas1`),
            conf
        );

        setInterval(atualizarGrafico, 2000);
    }


    // Esta função *atualizarGrafico* atualiza o gráfico que foi renderizado na página,
    // buscando a última medida inserida em tabela contendo as capturas, 

    //     Se quiser alterar a busca, ajuste as regras de negócio em src/controllers
    //     Para ajustar o "select", ajuste o comando sql em src/models
function atualizarGrafico() {
    fkUsuario = sessionStorage.ID_USUARIO
      fetch(`/grafico/graficoTotalL`, { cache: 'no-store' })
        .then(response => response.json())
        .then(Curtidas => {

            // Atualiza o dataset existente
            myChart1.data.datasets[0].data[1] = Curtidas[0]["count(opiniao)"];

            // Atualiza a exibição
            myChart1.update();
         console.log("Gráfico atualizado:", Curtidas[0]["count(opiniao)"]);
        })
    fetch(`/grafico/graficoTotalD`, { cache: 'no-store' })
        .then(response => response.json())
        .then(Descurtidas => {

            // Atualiza o dataset existente
            myChart1.data.datasets[0].data[0] = Descurtidas[0]["count(opiniao)"];

            // Atualiza a exibição
            myChart1.update();
         console.log("Gráfico atualizado:", Descurtidas[0]["count(opiniao)"]);
        })
    fetch(`/grafico/grafico/${fkUsuario}`, { cache: 'no-store' })
        .then(response => response.json())
        .then(likes => {

            // Atualiza o dataset existente
            myChart.data.datasets[0].data[0] = likes[0]["count(opiniao)"];

            // Atualiza a exibição
            myChart.update();

            console.log("Gráfico atualizado:", likes[0]["count(opiniao)"]);
        })
        .catch(err => console.error("Erro ao atualizar gráfico:", err));

        fetch(`/grafico/graficoDois/${fkUsuario}`, { cache: 'no-store' })
        .then(response => response.json())
        .then(dislikes => {

            // Atualiza o dataset existente
            myChart.data.datasets[1].data[0] = dislikes[0]["count(opiniao)"];

            // Atualiza a exibição
            myChart.update();

            console.log("Gráfico atualizado:", dislikes[0]["count(opiniao)"]);
        })
        .catch(err => console.error("Erro ao atualizar gráfico:", err));
}

grafico(); 
</script>

</script>